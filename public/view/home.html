<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
            <meta content="ThemeStarz" name="author">
                <title>
                    Peta Wisata Kota Batu
                </title>
                <!-- FONT -->
                <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel="stylesheet"/>
                <link href="https://fonts.googleapis.com/css?family=Signika+Negative" rel="stylesheet"/>
                <link href="{{baseUrl}}/public/css/font-awesome.min.css" rel="stylesheet"/>
                <!-- CORE -->
                <link href="{{baseUrl}}/public/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
                <link href="{{baseUrl}}/public/css/jquery.slider.min.css" rel="stylesheet" type="text/css"/>
                <link href="{{baseUrl}}/public/css/style.css" rel="stylesheet" type="text/css"/>
                <link href="{{baseUrl}}/favicon.ico" rel="Batu Tourism Map" type="image/x-icon"/>
                <!-- OPTIMASI -->
                <link href="https://batutourismmap.com/" rel="canonical"/>
                <meta content="Peta wisata kota batu merupakan sebuah peta yang menampilkan lokasi-lokasi wisata yang ada di kota Batu" name="description"/>
                <meta content="noodp" name="robots"/>
                <meta content="id_ID" property="og:locale"/>
                <meta content="website" property="og:type"/>
                <meta content="Peta Wisata Kota Batu | Batu Toursim Map" property="og:title"/>
                <meta content="A6mvQjJ45sZLEOt1I5LK8uqa5K2ND0tCiX-oM99M7nw" name="google-site-verification"/>
            </meta>
        </meta>
    </head>
    <body class="page-homepage map-google" data-offset="90" data-spy="scroll" data-target=".navigation" id="page-top">
        <div class="wrapper">
            <div class="navigation">
                <div class="container">
                    <header class="navbar" id="top" role="banner">
                        <div class="navbar-header">
                            <button class="navbar-toggle" data-target=".bs-navbar-collapse" data-toggle="collapse" type="button">
                                <span class="sr-only">
                                    Toggle navigation
                                </span>
                                <span class="icon-bar">
                                </span>
                                <span class="icon-bar">
                                </span>
                                <span class="icon-bar">
                                </span>
                            </button>
                            <div class="navbar-brand nav" id="brand">
                                <a href="{{path_for('index')}}">
                                    <span class="logo-styled">
                                        <span class="logo-title">
                                            <img alt="" src="{{baseUrl}}/public/images/logo.png">
                                                Batu
                                            </img>
                                        </span>
                                        <span class="logo-subtitle hidden-sm">
                                            Tourism
                                            <br>
                                                Map
                                            </br>
                                        </span>
                                    </span>
                                </a>
                            </div>
                        </div>
                        <nav class="collapse navbar-collapse bs-navbar-collapse navbar-right" role="navigation">
                            {% include 'layout/menu.html' %}
                        </nav>
                    </header>
                </div>
            </div>
            <div class="container">
                <div class="geo-location-wrapper">
                    <span class="btn btn-primary geo-location" id="getLoc">
                        <i class="fa fa-map-marker">
                        </i>
                        <span class="text">
                            Lokasi Saya
                        </span>
                    </span>
                </div>
                <div class="geo-location-wrapper">
                    <span class="btn btn-success geo-location" onclick="showSearch()" style="top: 20px;">
                        <i class="fa fa-search" style="font-size: 15px;">
                        </i>
                        <span class="text">
                            Pencarian
                        </span>
                    </span>
                </div>
            </div>
            <div class="map-canvas">
                <div class="map">
                    <div id="map" style="height: 700px!important;">
                    </div>
                    <div class="search-bar horizontal">
                        <form class="form-inline" role="form">
                            <center>
                                <div class="">
                                    <div class="col-md-12">
                                        <div class="form-group form-cari">
                                            <input class="form-control form-search" id="keyword" placeholder="Kata Kunci Pencarian" type="text">
                                            </input>
                                        </div>
                                        <div class="form-group form-cari">
                                            <select class="form-control form-search" id="kategori" name="kategori">
                                                <option value="">
                                                    .: Semua Kategori :.
                                                </option>
                                                {% for key, val in kategori %}
                                                <option value="{{val.id}}">
                                                    {{val.nama}}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group form-cari" style="width: initial;">
                                            <button class="btn btn-default" id="cari" style="padding: 9px 15px;" type="button">
                                                <i class="fa fa-search">
                                                </i>
                                            </button>
                                            <button class="btn btn-default" id="close" onclick="hideSearch()" style="padding: 9px 15px;" type="button">
                                                <i class="fa fa-close">
                                                </i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </center>
                        </form>
                    </div>
                </div>
            </div>
            <footer id="page-footer">
                <div class="inner">
                    <aside id="footer-copyright">
                        <div class="container">
                            <span>
                                Copyright Â© 2017. All Rights Reserved.
                            </span>
                            <span class="pull-right">
                                <a class="roll" href="#page-top">
                                    Go to top
                                </a>
                            </span>
                        </div>
                    </aside>
                </div>
            </footer>
        </div>
        <script src="{{baseUrl}}/public/js/jquery-2.1.0.min.js" type="text/javascript">
        </script>
        <script src="{{baseUrl}}/public/bootstrap/js/bootstrap.min.js" type="text/javascript">
        </script>
        <script src="{{baseUrl}}/public/js/smoothscroll.js" type="text/javascript">
        </script>
        <script src="{{baseUrl}}/public/js/custom.js" type="text/javascript">
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6YYW2yTplkQfLOxBGk8ZkTPa3Gbckun0">
        </script>
        <script src="{{baseUrl}}/public/js/markerwithlabel_packed.js" type="text/javascript">
        </script>
        <script src="{{baseUrl}}/public/js/infobox.js" type="text/javascript">
        </script>
        <script>
            $(document).ready(function($) {
                var _latitude = -7.871162;
                var _longitude = 112.526753;
                var _url = '{{baseUrl}}';
                var keyword = kategori = '';
                var mapCenter = {
                    lat: _latitude,
                    lng: _longitude
                };
                var newMarkers = [];
                var locmarker;
                /** Inialisasi Map */
                var map = new google.maps.Map(document.getElementById('map'), {
                    scrollwheel: false,
                    zoom: 15,
                    center: mapCenter,
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.BOTTOM_CENTER
                    },
                    gestureHandling: 'greedy',
                    mapTypeId: 'roadmap',
                    styles: [{
                        featureType: 'poi.attraction',
                        elementType: 'labels',
                        stylers: [{
                            visibility: 'off'
                        }]
                    },
                    ]
                });
                /** End Inialisasi Map */
                /** Setting Marker */
                var infoWindow = new google.maps.InfoWindow;

                downloadUrl(_url + '/getloc.php?keyword=' + keyword + '&kategori=' + kategori, function(data) {
                    var xml = data.responseXML;
                    var markers = xml.documentElement.getElementsByTagName('marker');
                    setLoc(markers);
                });


                var directionsService = new google.maps.DirectionsService;
                var directionsDisplay = new google.maps.DirectionsRenderer;

                function getDirection(lat, lng){
                    /** set destination */
                    var destination = new google.maps.LatLng(lat, lng);

                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var _dirLat = position.coords.latitude;
                            var _dirLng = position.coords.longitude;
                            var origin = new google.maps.LatLng(_dirLat, _dirLng);
                            map.setCenter({
                                lat : _dirLat,
                                lng : _dirLng
                            });
                            directionsDisplay.setMap(map);
                            directionsService.route({
                              origin: origin,
                              destination: destination,
                              travelMode: 'DRIVING'
                            }, function(response, status) {
                              if (status === 'OK') {
                                directionsDisplay.setDirections(response);
                              } else {
                                window.alert('Directions request failed due to ' + status);
                              }
                            });
                        }, function error(msg) {
                            alert('Please enable your GPS position future.');
                        });
                    } else {
                        alert("Geolocation API is not supported in your browser.");
                    }
                }

                function DeleteMarkers() {
                    //Loop through all the markers and remove
                    for (var i = 0; i < newMarkers.length; i++) {
                        newMarkers[i].setMap(null);
                    }
                    newMarkers = [];
                };

                function resetMyPosition(){
                    locmarker.setMap(null);
                }

                function setLoc(markers){
                    DeleteMarkers();
                    var i = 0;
                    infobox = new InfoBox();
                    Array.prototype.forEach.call(markers, function(markerElem) {
                        /** set map center */
                        if(i == 0 && ($("#kategori").val() != '' || $("#keyword").val() != '')){
                            var ctr = new google.maps.LatLng(markerElem.getAttribute('lat'), markerElem.getAttribute('lng'));
                            map.setCenter(ctr);
                        }
                        var infowincontent = document.createElement('div');
                        var pictureLabel = document.createElement("img");
                        pictureLabel.src = _url + '/public/images/noimage.jpg';
                        infowincontent.innerHTML = '<div class="infobox-inner">' + 
                            '<a href="">' + 
                                '<div class="infobox-image" style="position: relative; width: 250px; overflow: hidden">' + 
                                    '<img src="' + _url + '/'+markerElem.getAttribute('img')+'" style="margin-top: -20%; width:350px;">' + 
                                    '<div><span class="infobox-price">' + markerElem.getAttribute('name') + '</span></div>' + 
                                '</div>' + 
                            '</a>' + 
                            '<div class="infobox-description">' + 
                                '<div class="infobox-location" style="margin-top:10px;">' + 
                                    '<a class="btn btn-primary" href="'+_url+'/wisata/'+ markerElem.getAttribute('id') +'/'+markerElem.getAttribute('alias')+'.html" style="width: 48%">' + 
                                        '<span class="fa fa-search"></span> Detail ' + 
                                    '</a>' + 
                                    '<a class="btn btn-primary getdirect" href="#" style="width: 50%; float: right;" data-lat="'+markerElem.getAttribute('lat')+'" data-lang="'+markerElem.getAttribute('lng')+'">'+
                                        '<span class="fa fa-eye"></span> Lihat Rute'+
                                    '</a>' + 
                                '</div>' + 
                            '</div>' + 
                        '</div>';
                        infoboxOptions = {
                            content: infowincontent,
                            disableAutoPan: false,
                            pixelOffset: new google.maps.Size(-100, 0),
                            zIndex: null,
                            alignBottom: true,
                            boxClass: "infobox-wrapper",
                            enableEventPropagation: true,
                            closeBoxMargin: "0px 0px -8px 0px",
                            closeBoxURL: _url + "/public/images/map/close-btn.png",
                            infoBoxClearance: new google.maps.Size(1, 1)
                        };
                        /** Set size icon */
                        var imageIcon = new google.maps.MarkerImage(markerElem.getAttribute('icon'), new google.maps.Size(71, 71), new google.maps.Point(0, 0), new google.maps.Point(17, 34), new google.maps.Size(42, 42));
                        /** Set marker */
                        var marker = new google.maps.Marker({
                            title: name,
                            position: new google.maps.LatLng(markerElem.getAttribute('lat'), markerElem.getAttribute('lng')),
                            map: map,
                            icon: imageIcon,
                        });
                        newMarkers.push(marker);
                        newMarkers[i].infobox = new InfoBox(infoboxOptions);
                        google.maps.event.addListener(marker, 'click', (function(marker, i) {
                            return function() {
                                for (h = 0; h < newMarkers.length; h++) {
                                    newMarkers[h].infobox.close();
                                }
                                newMarkers[i].infobox.open(map, this);

                                newMarkers[i].infobox.addListener("domready", function() {
                                    $(".getdirect").on("click", function(e) {
                                        newMarkers[i].infobox.close();
                                        getDirection($(this).data('lat'), $(this).data('lang'));
                                    });
                                });
                            }
                        })(marker, i));
                        i++;
                    });
                    /** End Marker */
                }

                function downloadUrl(url, callback) {
                    var request = window.ActiveXObject ? new ActiveXObject('Microsoft.XMLHTTP') : new XMLHttpRequest;
                    request.onreadystatechange = function() {
                        if (request.readyState == 4) {
                            request.onreadystatechange = doNothing;
                            callback(request, request.status);
                        }
                    };
                    request.open('GET', url, true);
                    request.send(null);
                }

                function doNothing() {}

                function getLocation(){
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var _dirLat = position.coords.latitude;
                            var _dirLng = position.coords.longitude;
                            locmarker = new google.maps.Marker({
                                title: 'Posisi Saya',
                                position: new google.maps.LatLng(_dirLat, _dirLng),
                                map: map,
                            });
                            map.setCenter({
                                lat : _dirLat,
                                lng : _dirLng
                            });
                        }, function error(msg) {
                            alert('Please enable your GPS position future.');
                        });
                    } else {
                        alert("Geolocation API is not supported in your browser.");
                    }
                }

                $("#getLoc").click(function() {
                    getLocation();
                });

                $("#cari").click(function() {
                    downloadUrl(_url + '/getloc.php?keyword=' + $("#keyword").val() + '&kategori=' + $("#kategori").val(), function(data) {
                        var xml = data.responseXML;
                        var markers = xml.documentElement.getElementsByTagName('marker');
                        setLoc(markers);
                    });
                });
            });

            google.maps.event.trigger(map, "resize");

            function showSearch(){
                $(".search-bar").show();
            }

            function hideSearch(){
                $(".search-bar").hide();
            }

            hideSearch();
        </script>
    </body>
</html>